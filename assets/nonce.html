<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
<title>Just a minute...</title>
<body>
<h1>Just a minute,</h1>
<h2>Robots are verifying that you aren't one of them</h2>
<pre>
       __,_,
  [_|_/
   //
 _//    __
(_|)   |@@|
 \ \__ \--/ __
  \o__|----|  |   __
      \ }{ /\ )_ / _\
      /\__/\ \__O (__
     (--/\--)    \__/
     _)(  )(_
    `---''---`
</pre>
<script>
    (async () => {
        async function sha256(value) {
            const utf8 = new TextEncoder().encode(value);
            return await crypto.subtle.digest('SHA-256', utf8)
                .then(buffer => Array.from(new Uint8Array(buffer))
                    .map(bytes => bytes.toString(16))
                    .join('')
                );
        }

        function get_cookie(name) {
            const cookies = decodeURIComponent(document.cookie).split(';');
            for (const cookie of cookies) {
                const offset = cookie.charAt(0) === ' ' ? 1 : 0;
                if (cookie.startsWith(name, offset)) return cookie.substring(offset + name.length + 1);
            }

            return null;
        }

        function set_cookie(name, value) {
            document.cookie = `${name}=${value}; path=/; SameSite=Lax`
        }

        async function find_answer(prefix, suffix, hash_suffix, step, begin) {
            while (true) {
                const string = prefix + begin.toString(36) + suffix;
                const hash = await sha256(string);
                if (hash.endsWith(hash_suffix)) return string;

                begin += step;
            }
        }

        const raw_nonce = get_cookie('COMPROXITY_NONCE');
        if (raw_nonce == null) {
            console.error('No raw_nonce is specified');
            return;
        }

        class JWT {
            constructor(jwt) {
                const delimiter1Index = jwt.indexOf('.');
                const delimiter2Index = jwt.indexOf('.', delimiter1Index + 1);

                this.header = JSON.parse(atob(jwt.substring(0, delimiter1Index)));
                this.payload = JSON.parse(atob(jwt.substring(delimiter1Index + 1, delimiter2Index)));
            }
        }

        const nonce = await new JWT(raw_nonce);
        const payload = nonce.payload;

        const concurrency = 16;
        const tasks = [];
        for (let i = 0; i < concurrency; i++) tasks
            .push(find_answer(payload.prefix, payload.suffix, payload.hash_suffix, concurrency, i));

        Promise.race(tasks).then(answer => {
            set_cookie('COMPROXITY_ANSWER', answer);
            location.reload();
        })
    })()
</script>
</body>
</html>
